x <- LETTERS[1:20]
y <- paste0("var", seq(1,20))
data <- expand.grid(X=x, Y=y)
View(data)
data$Z <- runif(400, 0, 5)
View(data)
library(RNifti)
citation("RNifti")
#install.packages("here")
#install.packages("RNifti", repos = "https://cloud.r-project.org")
#install.packages("tidyverse", repos = "https://cloud.r-project.org")
library(tidyverse)
library(here)
library(RNifti)
# download anatomical brain MRI for creating mask/plotting
anatomical_file_path <- here("data", "sub-001_T1w.nii", "sub-001_T1w.nii")
anatomical_data <- readNifti(anatomical_file_path)
# download functional MRI
functional_file_path <- here("data", "shortened_fMRI_data.nii")
functional_image_data <- readNifti(functional_file_path, internal = T)
# create rudimentary brain mask from anatomical data to reduce computation in analysis
brain_mask <- cbind(which(anatomical_data > 0, arr.ind = TRUE),
which(anatomical_data > 0))
# select seed voxel o be correlated with the rest of the brain. We select a voxel of
#the precuneus, a known center of the DMN (https://www.jneurosci.org/content/34/3/932.short)
#set.seed(1000)
#brain_mask_row <- sample(1:nrow(brain_mask),1) # >= 100000 for now
select_seed_voxel <- list(x = 50,
y = 38,
z = 65)
seed_time_series <- functional_image_data[select_seed_voxel$x,
select_seed_voxel$y,
select_seed_voxel$z,]
nt <- length(seed_time_series)
# find pearson correlation with all other voxels in mask
X <- matrix(NA, nrow = nt, ncol = nrow(brain_mask)) # make matrix t x length of mask obtained from ana
for(i in 1:nt){
X[i,] <- functional_image_data[,,,i][brain_mask[,4]]
#grab a whole brain at time i then only take the mask voxels from it
}
rm(functional_image_data)
gc()
s_z <-scale(seed_time_series)
corr_vector <- (1/(nt-1))*t(s_z)%*%scale(X)
#corr_vector_old <- apply(X, MARGIN = 2, function(x){
#  corr <- cor(x, seed_time_series)
#})
corr_frame <- as_tibble(t(corr_vector)) %>%
mutate(which_voxel = brain_mask[,4],
which_mask_voxel = row_number(),
value = ifelse(is.nan(V1), NA_real_, V1)) %>%
arrange(desc(abs(value)))
# find k largest magnitude corr time series
k <- 31
#### sorted voxels
highest_correlation_voxels <- as.data.frame(X[,corr_frame$which_mask_voxel[seq_len(k)]])
rm(X)
gc()
#install.packages("ggplot2", repos = "https://cloud.r-project.org")
#install.packages("ggnewscale", repos = "https://cloud.r-project.org")
library(ggplot2)
library(ggnewscale)
# need a long data frame with columns for voxel #, bold value at time t,
# and correlation with seed
long_correlation_frame <- highest_correlation_voxels %>%
setNames(corr_frame$which_mask_voxel[1:k]) %>%
pivot_longer(cols = everything(),
names_to = "Voxel") %>%
mutate(Voxel = as.numeric(Voxel)) %>%
arrange(Voxel) %>%
left_join(corr_frame,
by = join_by(Voxel == which_mask_voxel)) %>%
group_by(Voxel) %>%
mutate(time = row_number()) %>%
rename("BOLD Intensity" = value.x,
"Correlation" = value.y) %>%
select(-which_voxel) %>% mutate(source = "Voxel")
### Plot seed time series along with other ###
seed_frame <- as_tibble(seed_time_series) %>% mutate(time = seq_len(nt),
source = "Seed") %>%
rename("BOLD Intensity" = value)
bold_lineplot <- ggplot(
long_correlation_frame,
aes(
x = time,
y = `BOLD Intensity`,
group = Voxel,
alpha = Correlation,
color = source
)
) +
geom_line() +
geom_line(
data = seed_frame,
aes(x = time, y = `BOLD Intensity`, color = source),
linewidth = 1,
inherit.aes = FALSE
) +
scale_color_manual(
values = c("Voxel" = "red", "Seed" = "black"),
name = NULL
) +
labs(title = paste(k-1, "most correlated voxels with seed voxel"),
x = "Scanned brain volumes across time")
### Plot only anatomical brain ###
# sagittal_anatomical_plot <-slice_plotter(img = anatomical_data,
#                                          plane = "S",
#                                          slice_ind = select_seed_voxel$x)
#
# coronal_anatomical_plot <-slice_plotter(img = anatomical_data,
#                                          plane = "C",
#                                          slice_ind = select_seed_voxel$y)
#
# axial_anatomical_plot <-slice_plotter(img = anatomical_data,
#                                         plane = "A",
#                                         slice_ind = select_seed_voxel$y)
### Plot anatomical brain with correlation based heatmap ###
sagittal_connectivity_plot <- connectivity_plotter(mask = brain_mask,
corr_frame = corr_frame,
anat_data = anatomical_data,
seed = select_seed_voxel,
plane = "S")
connectivity_plotter <- function(mask, corr_frame, anat_data, seed, plane){
#SAGITTAL
if (plane == "S"){
plane_name <- "Sagittal"
seed_slice <- anat_data[seed$x,,]
slice_longer <- expand.grid(Y = seq_len(nrow(seed_slice)),
Z = seq_len(ncol(seed_slice))) %>%
mutate(intensity = as.vector(seed_slice))
mask_new <- as.data.frame(mask) %>% mutate(which_voxel = V4) %>% select(-V4)
corr_intensity_frame <- inner_join(mask_new, corr_frame) %>% rename(X = dim1,
Y = dim2,
Z = dim3,
correlation = value)
slice_corr_intensity <- corr_intensity_frame %>% filter(X == seed$x) %>%
inner_join(.,slice_longer, by=join_by(Y,Z))
plot <- ggplot() +
geom_tile(data = slice_corr_intensity, aes(x = Y, y = Z, fill = intensity)) +
scale_fill_gradient(low = "black", high = "white") + guides(fill = "none") +
new_scale_fill() +
geom_tile(data=slice_corr_intensity, aes(x=Y, y=Z, fill = correlation),
alpha = 0.6) +
scale_fill_viridis_c(option = "magma") +
annotate("point", x = seed$y, y = seed$z,
color = "red", size = 3) +
coord_equal() + labs(title = paste0("Whole-brain seed connectivity",
" (", plane_name, ")"))
}
#CORONAL
if (plane == "C"){
plane_name <- "Coronal"
seed_slice <- anat_data[,seed$y,]
slice_longer <- expand.grid(X = seq_len(nrow(seed_slice)),
Z = seq_len(ncol(seed_slice))) %>%
mutate(intensity = as.vector(seed_slice))
mask_new <- as.data.frame(mask) %>% mutate(which_voxel = V4) %>% select(-V4)
corr_intensity_frame <- inner_join(mask_new, corr_frame) %>% rename(X = dim1,
Y = dim2,
Z = dim3,
correlation = value)
slice_corr_intensity <- corr_intensity_frame %>% filter(Y == seed$y) %>%
inner_join(.,slice_longer, by=join_by(X,Z))
plot <- ggplot() +
geom_tile(data = slice_corr_intensity, aes(x = X, y = Z, fill = intensity)) +
scale_fill_gradient(low = "black", high = "white") + guides(fill = "none") +
new_scale_fill() +
geom_tile(data=slice_corr_intensity, aes(x=X, y=Z, fill = correlation),
alpha = 0.6) +
scale_fill_viridis_c(option = "magma") +
annotate("point", x = seed$x, y = seed$z,
color = "red", size = 3) +
coord_equal() + labs(title = paste0("Whole-brain seed connectivity",
" (", plane_name, ")"))
}
#AXIAL
if (plane == "A"){
plane_name <- "Axial"
seed_slice <- anat_data[,,seed$z]
slice_longer <- expand.grid(X = seq_len(nrow(seed_slice)),
Y = seq_len(ncol(seed_slice))) %>%
mutate(intensity = as.vector(seed_slice))
mask_new <- as.data.frame(mask) %>% mutate(which_voxel = V4) %>% select(-V4)
corr_intensity_frame <- inner_join(mask_new, corr_frame) %>% rename(X = dim1,
Y = dim2,
Z = dim3,
correlation = value)
slice_corr_intensity <- corr_intensity_frame %>% filter(Z == seed$z) %>%
inner_join(.,slice_longer, by=join_by(X,Y))
plot <- ggplot() +
geom_tile(data = slice_corr_intensity, aes(x = X, y = Y, fill = intensity)) +
scale_fill_gradient(low = "black", high = "white") + guides(fill = "none") +
new_scale_fill() +
geom_tile(data=slice_corr_intensity, aes(x=X, y=Y, fill = correlation),
alpha = 0.6) +
scale_fill_viridis_c(option = "magma") +
annotate("point", x = seed$x, y = seed$y,
color = "red", size = 3) +
coord_equal() + labs(title = paste0("Whole-brain seed connectivity",
" (", plane_name, ")"))
}
return(plot)
}
slice_plotter <- function(img, plane, slice_ind){
dim_img <- dim(img)
if(plane == "S"){
if (slice_ind > dim_img[1]){
stop("Slice index must not exceed maximum slice index for sagittal plane")
} else {
single_slice <- img[slice_ind,,]
single_slice_longer <- expand.grid(X = seq_len(nrow(single_slice)),
Y = seq_len(ncol(single_slice))
)
plottable_slice <- single_slice_longer %>% mutate(value = as.vector(single_slice))
slice_plot <- ggplot(plottable_slice, aes(X, Y, fill = value)) +
geom_tile() + theme_void() + scale_fill_gradient(
low = "black",
high = "white"
)
slice_plot
}
}else if (plane == "C"){
if (slice_ind > dim_img[2]){
stop("Slice index must not exceed maximum slice index for coronal plane")
} else {
single_slice <- img[,slice_ind,]
single_slice_longer <- expand.grid(X = seq_len(nrow(single_slice)),
Y = seq_len(ncol(single_slice))
)
plottable_slice <- single_slice_longer %>% mutate(value = as.vector(single_slice))
slice_plot <- ggplot(plottable_slice, aes(X, Y, fill = value)) +
geom_tile() + theme_void() + scale_fill_gradient(
low = "black",
high = "white"
)
slice_plot
}
} else if (plane == "A"){
if (slice_ind > dim_img[3]){
stop("Slice index must not exceed maximum slice index for axial plane")
} else {
single_slice <- img[,,slice_ind]
single_slice_longer <- expand.grid(X = seq_len(nrow(single_slice)),
Y = seq_len(ncol(single_slice))
)
plottable_slice <- single_slice_longer %>% mutate(value = as.vector(single_slice))
slice_plot <- ggplot(plottable_slice, aes(X, Y, fill = value)) +
geom_tile() + theme_void() + scale_fill_gradient(
low = "black",
high = "white"
)
slice_plot
}
} else {
stop("Plane must be S for Sagittal images, C for coronal images, or A for Axial images")
}
}
#install.packages("ggplot2", repos = "https://cloud.r-project.org")
#install.packages("ggnewscale", repos = "https://cloud.r-project.org")
library(ggplot2)
library(ggnewscale)
# need a long data frame with columns for voxel #, bold value at time t,
# and correlation with seed
long_correlation_frame <- highest_correlation_voxels %>%
setNames(corr_frame$which_mask_voxel[1:k]) %>%
pivot_longer(cols = everything(),
names_to = "Voxel") %>%
mutate(Voxel = as.numeric(Voxel)) %>%
arrange(Voxel) %>%
left_join(corr_frame,
by = join_by(Voxel == which_mask_voxel)) %>%
group_by(Voxel) %>%
mutate(time = row_number()) %>%
rename("BOLD Intensity" = value.x,
"Correlation" = value.y) %>%
select(-which_voxel) %>% mutate(source = "Voxel")
### Plot seed time series along with other ###
seed_frame <- as_tibble(seed_time_series) %>% mutate(time = seq_len(nt),
source = "Seed") %>%
rename("BOLD Intensity" = value)
bold_lineplot <- ggplot(
long_correlation_frame,
aes(
x = time,
y = `BOLD Intensity`,
group = Voxel,
alpha = Correlation,
color = source
)
) +
geom_line() +
geom_line(
data = seed_frame,
aes(x = time, y = `BOLD Intensity`, color = source),
linewidth = 1,
inherit.aes = FALSE
) +
scale_color_manual(
values = c("Voxel" = "red", "Seed" = "black"),
name = NULL
) +
labs(title = paste(k-1, "most correlated voxels with seed voxel"),
x = "Scanned brain volumes across time")
### Plot only anatomical brain ###
# sagittal_anatomical_plot <-slice_plotter(img = anatomical_data,
#                                          plane = "S",
#                                          slice_ind = select_seed_voxel$x)
#
# coronal_anatomical_plot <-slice_plotter(img = anatomical_data,
#                                          plane = "C",
#                                          slice_ind = select_seed_voxel$y)
#
# axial_anatomical_plot <-slice_plotter(img = anatomical_data,
#                                         plane = "A",
#                                         slice_ind = select_seed_voxel$y)
### Plot anatomical brain with correlation based heatmap ###
sagittal_connectivity_plot <- connectivity_plotter(mask = brain_mask,
corr_frame = corr_frame,
anat_data = anatomical_data,
seed = select_seed_voxel,
plane = "S")
coronal_connectivity_plot <- connectivity_plotter(mask = brain_mask,
corr_frame = corr_frame,
anat_data = anatomical_data,
seed = select_seed_voxel,
plane = "C")
axial_connectivity_plot <- connectivity_plotter(mask = brain_mask,
corr_frame = corr_frame,
anat_data = anatomical_data,
seed = select_seed_voxel,
plane = "A")
# call plots
sagittal_connectivity_plot
coronal_connectivity_plot
axial_connectivity_plot
session.Info()
sessionInfo()
